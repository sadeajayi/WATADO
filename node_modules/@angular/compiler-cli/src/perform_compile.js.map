{"version":3,"file":"perform_compile.js","sourceRoot":"","sources":["../../../../packages/compiler-cli/src/perform_compile.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {isSyntaxError, syntaxError} from '@angular/compiler';\nimport {createBundleIndexHost} from '@angular/tsc-wrapped';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport * as ts from 'typescript';\n\nimport * as api from './transformers/api';\nimport * as ng from './transformers/entry_points';\n\nconst TS_EXT = /\\.ts$/;\n\nexport type Diagnostics = Array<ts.Diagnostic|api.Diagnostic>;\n\nfunction isTsDiagnostic(diagnostic: any): diagnostic is ts.Diagnostic {\n  return diagnostic && diagnostic.source != 'angular';\n}\n\nexport function formatDiagnostics(options: api.CompilerOptions, diags: Diagnostics): string {\n  if (diags && diags.length) {\n    const tsFormatHost: ts.FormatDiagnosticsHost = {\n      getCurrentDirectory: () => options.basePath || process.cwd(),\n      getCanonicalFileName: fileName => fileName,\n      getNewLine: () => ts.sys.newLine\n    };\n    return diags\n        .map(d => {\n          if (isTsDiagnostic(d)) {\n            return ts.formatDiagnostics([d], tsFormatHost);\n          } else {\n            let res = ts.DiagnosticCategory[d.category];\n            if (d.span) {\n              res +=\n                  ` at ${d.span.start.file.url}(${d.span.start.line + 1},${d.span.start.col + 1})`;\n            }\n            if (d.span && d.span.details) {\n              res += `: ${d.span.details}, ${d.messageText}\\n`;\n            } else {\n              res += `: ${d.messageText}\\n`;\n            }\n            return res;\n          }\n        })\n        .join();\n  } else\n    return '';\n}\n\nexport interface ParsedConfiguration {\n  project: string;\n  options: api.CompilerOptions;\n  rootNames: string[];\n  errors: Diagnostics;\n}\n\nexport function calcProjectFileAndBasePath(project: string):\n    {projectFile: string, basePath: string} {\n  const projectIsDir = fs.lstatSync(project).isDirectory();\n  const projectFile = projectIsDir ? path.join(project, 'tsconfig.json') : project;\n  const projectDir = projectIsDir ? project : path.dirname(project);\n  const basePath = path.resolve(process.cwd(), projectDir);\n  return {projectFile, basePath};\n}\n\nexport function createNgCompilerOptions(\n    basePath: string, config: any, tsOptions: ts.CompilerOptions): api.CompilerOptions {\n  return {...tsOptions, ...config.angularCompilerOptions, genDir: basePath, basePath};\n}\n\nexport function readConfiguration(\n    project: string, existingOptions?: ts.CompilerOptions): ParsedConfiguration {\n  try {\n    const {projectFile, basePath} = calcProjectFileAndBasePath(project);\n\n    let {config, error} = ts.readConfigFile(projectFile, ts.sys.readFile);\n\n    if (error) {\n      return {project, errors: [error], rootNames: [], options: {}};\n    }\n    const parseConfigHost = {\n      useCaseSensitiveFileNames: true,\n      fileExists: fs.existsSync,\n      readDirectory: ts.sys.readDirectory,\n      readFile: ts.sys.readFile\n    };\n    const parsed =\n        ts.parseJsonConfigFileContent(config, parseConfigHost, basePath, existingOptions);\n    const rootNames = parsed.fileNames.map(f => path.normalize(f));\n\n    const options = createNgCompilerOptions(basePath, config, parsed.options);\n    return {project: projectFile, rootNames, options, errors: parsed.errors};\n  } catch (e) {\n    const errors: Diagnostics = [{\n      category: ts.DiagnosticCategory.Error,\n      messageText: e.stack,\n      source: api.SOURCE,\n      code: api.UNKNOWN_ERROR_CODE\n    }];\n    return {project: '', errors, rootNames: [], options: {}};\n  }\n}\n\nexport interface PerformCompilationResult {\n  diagnostics: Diagnostics;\n  program?: api.Program;\n  emitResult?: ts.EmitResult;\n}\n\nexport function exitCodeFromResult(result: PerformCompilationResult | undefined): number {\n  if (!result) {\n    // If we didn't get a result we should return failure.\n    return 1;\n  }\n  if (!result.diagnostics || result.diagnostics.length === 0) {\n    // If we have a result and didn't get any errors, we succeeded.\n    return 0;\n  }\n\n  // Return 2 if any of the errors were unknown.\n  return result.diagnostics.some(d => d.source === 'angular' && d.code === api.UNKNOWN_ERROR_CODE) ?\n      2 :\n      1;\n}\n\nexport function performCompilation(\n    {rootNames, options, host, oldProgram, emitCallback, customTransformers}: {\n      rootNames: string[],\n      options: api.CompilerOptions,\n      host?: api.CompilerHost,\n      oldProgram?: api.Program,\n      emitCallback?: api.TsEmitCallback,\n      customTransformers?: api.CustomTransformers\n    }): PerformCompilationResult {\n  const [major, minor] = ts.version.split('.');\n\n  if (Number(major) < 2 || (Number(major) === 2 && Number(minor) < 3)) {\n    throw new Error('Must use TypeScript > 2.3 to have transformer support');\n  }\n\n  const allDiagnostics: Diagnostics = [];\n\n  function checkDiagnostics(diags: Diagnostics | undefined) {\n    if (diags) {\n      allDiagnostics.push(...diags);\n      return diags.every(d => d.category !== ts.DiagnosticCategory.Error);\n    }\n    return true;\n  }\n\n  let program: api.Program|undefined;\n  let emitResult: ts.EmitResult|undefined;\n  try {\n    if (!host) {\n      host = ng.createCompilerHost({options});\n    }\n\n    program = ng.createProgram({rootNames, host, options, oldProgram});\n\n    let shouldEmit = true;\n    // Check parameter diagnostics\n    shouldEmit = shouldEmit && checkDiagnostics([\n                   ...program !.getTsOptionDiagnostics(), ...program !.getNgOptionDiagnostics()\n                 ]);\n\n    // Check syntactic diagnostics\n    shouldEmit = shouldEmit && checkDiagnostics(program !.getTsSyntacticDiagnostics());\n\n    // Check TypeScript semantic and Angular structure diagnostics\n    shouldEmit =\n        shouldEmit &&\n        checkDiagnostics(\n            [...program !.getTsSemanticDiagnostics(), ...program !.getNgStructuralDiagnostics()]);\n\n    // Check Angular semantic diagnostics\n    shouldEmit = shouldEmit && checkDiagnostics(program !.getNgSemanticDiagnostics());\n\n    if (shouldEmit) {\n      emitResult = program !.emit({\n        emitCallback,\n        customTransformers,\n        emitFlags: api.EmitFlags.Default |\n            ((options.skipMetadataEmit || options.flatModuleOutFile) ? 0 : api.EmitFlags.Metadata)\n      });\n      allDiagnostics.push(...emitResult.diagnostics);\n      return {diagnostics: allDiagnostics, program, emitResult};\n    }\n    return {diagnostics: allDiagnostics, program};\n  } catch (e) {\n    let errMsg: string;\n    let code: number;\n    if (isSyntaxError(e)) {\n      // don't report the stack for syntax errors as they are well known errors.\n      errMsg = e.message;\n      code = api.DEFAULT_ERROR_CODE;\n    } else {\n      errMsg = e.stack;\n      // It is not a syntax error we might have a program with unknown state, discard it.\n      program = undefined;\n      code = api.UNKNOWN_ERROR_CODE;\n    }\n    allDiagnostics.push(\n        {category: ts.DiagnosticCategory.Error, messageText: errMsg, code, source: api.SOURCE});\n    return {diagnostics: allDiagnostics, program};\n  }\n}"]}